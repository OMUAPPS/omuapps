name: Upload Release to Cloudflare R2

on:
    workflow_dispatch:
        inputs:
            tag:
                description: 'Tag to upload'
                required: true
                type: string

permissions:
    contents: read

jobs:
    upload-to-r2:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v4

        - run: corepack enable

        - name: Setup Node.js
          uses: actions/setup-node@v4.0.3
          with:
            cache: 'pnpm'

        - name: Install dependencies
          run: pnpm i --frozen-lockfile

        - name: Download release assets
          uses: robinraju/release-downloader@v1
          with:
                token: ${{ secrets.GITHUB_TOKEN }}
                tag: ${{ github.event.inputs.tag }}
                out-file-path:  ./release-assets

        - name: Upload to Cloudflare R2
          env:
            CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            pnpm wrangler whoami
            node ./scripts/js-upload-to-r2.mjs --tag ${{ github.event.inputs.tag }}
