name: Upload Release to Cloudflare R2

on:
    release:
    workflow_dispatch:

permissions:
    contents: read

jobs:
    upload-to-r2:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v4

        - run: corepack enable

        - name: Setup Node.js
          uses: actions/setup-node@v4.0.3
          with:
            cache: 'pnpm'

        - name: Install dependencies
          run: pnpm i --frozen-lockfile

        - name: Create test file
          run: echo "Hello, world!" > test.txt

        - name: Upload test file
          uses: actions/upload-artifact@v4.6.0
          with:
                name: test
                path: test.txt

        - name: Download release assets
          uses: actions/download-artifact@v4.1.8
          with:
              path: ./release-assets

        - name: Upload to Cloudflare R2
          env:
            CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          run: |
            pnpm wrangler whoami
            for file in ./release-assets/*; do
                echo "Uploading $file"
                cat $file | pnpm wrangler r2 object put omuapps-app/test/$(basename $file) --pipe
            done
